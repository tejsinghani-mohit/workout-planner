<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Year-Long Workout Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- Application Structure Plan: The application is designed as an an interactive weekly dashboard. The primary view shows the current week's schedule in a 7-day grid, which is a highly intuitive structure for planning. Users can navigate between weeks. Clicking on a day reveals detailed workout information in a modal, preventing context loss and keeping the interface clean. A prominent "Today's Workout" card provides immediate, actionable information. Progress is tracked via checkboxes, which dynamically update a summary chart. This structure was chosen to transform a static plan into a dynamic, motivating, and easy-to-navigate tool that aligns with how users typically manage schedules. -->
    <!-- Visualization & Content Choices: Report Info: Daily workout schedule. -> Goal: Organize & Inform. -> Viz/Presentation: Interactive weekly grid of cards (HTML/Tailwind) with a modal (JS-driven) for details. -> Interaction: Click card to see details. -> Justification: Breaks down the year-long plan into manageable weekly chunks, preventing overwhelm. The modal keeps the user on the main dashboard. | Report Info: Workout completion. -> Goal: Engage & Motivate. -> Viz/Presentation: Checkboxes on each card and a donut chart (Chart.js). -> Interaction: Click checkbox to mark day complete, chart updates automatically. -> Justification: Provides instant visual feedback and a sense of accomplishment, encouraging engagement with the plan. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF8; /* Warm neutral background */
            color: #4A4A4A;
        }
        .day-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .day-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .day-card.completed {
            background-color: #F0FDF4; /* Light green */
            border-color: #22C55E; /* Green */
            opacity: 0.8;
        }
        .day-card.completed .day-title {
            color: #166534; /* Darker Green */
        }
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        .today-highlight {
            box-shadow: 0 0 0 2px #3B82F6;
            border-color: #3B82F6;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 300px;
        }
        #loading-overlay, #auth-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #FDFBF8; /* Consistent with body background */
            display: flex; /* Always start as flex for these */
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it's on top */
            font-size: 1.5rem;
            color: #4A4A4A;
            /* pointer-events is handled by .hidden */
        }
        #app {
            position: relative;
            z-index: 10; /* Lower than overlay */
        }
        .hidden {
            display: none !important;
            pointer-events: none !important; /* Crucial: ensure it's not interactive when hidden */
        }
    </style>
</head>
<body class="antialiased">

    <div id="loading-overlay">Loading your workout plan...</div>

    <div id="auth-page" class="hidden">
        <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-200 w-full max-w-md text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Welcome!</h2>
            <p class="text-gray-600 mb-6">Sign in or create an account to track your fitness journey.</p>
            <div class="space-y-4">
                <input type="email" id="auth-email" placeholder="Email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <input type="password" id="auth-password" placeholder="Password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            </div>
            <p id="auth-error-message" class="error-message hidden"></p>
            <div class="flex flex-col sm:flex-row gap-4 mt-6">
                <button id="signup-button" class="w-full sm:w-1/2 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">Sign Up</button>
                <button id="signin-button" class="w-full sm:w-1/2 bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold hover:bg-gray-300 transition-colors">Sign In</button>
            </div>
        </div>
    </div>

    <div id="app" class="container mx-auto p-4 sm:p-6 md:p-8 hidden">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Your Year-Long Fitness Journey (2025)</h1>
            <p class="mt-2 text-lg text-gray-600">Stay consistent, track your progress, and achieve your goals.</p>
            <p id="user-id-display" class="mt-2 text-sm text-gray-500"></p>
            <button id="signout-button" class="mt-4 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm">Sign Out</button>
        </header>

        <main>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <div id="today-workout-card" class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800 mb-3">Today's Workout: <span id="today-title"></span></h2>
                    <div id="today-details" class="text-gray-700 space-y-2"></div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 flex flex-col justify-center items-center">
                    <h2 class="text-2xl font-bold text-gray-800 mb-3 text-center">Your Progress</h2>
                    <p id="progress-chart-explanation" class="text-center text-gray-600 mb-4">This chart shows your progress for the current month.</p>
                    <div class="chart-container">
                        <canvas id="progressChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                <div class="flex justify-between items-center mb-6">
                    <button id="prev-week" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        &larr; Previous
                    </button>
                    <h2 id="week-title" class="text-xl sm:text-2xl font-bold text-center text-gray-800"></h2>
                    <button id="next-week" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        Next &rarr;
                    </button>
                </div>
                <p class="text-center text-gray-600 mb-6">Here is your plan for the week. Click on any day to view the full details of the workout. Use the checkbox in the top right of each card to mark a day as complete and track your progress.</p>
                <div id="weekly-view" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-7 gap-4">
                </div>
            </div>
        </main>

    </div>

    <div id="workout-modal" class="modal fixed inset-0 bg-black bg-opacity50 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-white w-full max-w-2xl rounded-2xl shadow-xl p-6 sm:p-8 transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-2xl font-bold text-gray-800"></h3>
                <button id="close-modal" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div id="modal-body" class="text-gray-700 space-y-4">
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        let db;
        let auth;
        let currentUserId = null;
        let isAuthAndDbReady = false;
        let unsubscribeFromFirestore = null; // Variable to hold the unsubscribe function

        // --- IMPORTANT: START YOUR EDITS HERE FOR GITHUB PAGES DEPLOYMENT ---
        // YOU MUST REPLACE ALL "YOUR_..." PLACEHOLDER VALUES BELOW WITH YOUR ACTUAL, EXACT CONFIGURATION FROM FIREBASE CONSOLE.
        // THIS IS THE MOST COMMON REASON FOR THE "API KEY NOT VALID" ERROR AND THE APP GETTING STUCK.
        //
        // Steps to get your config:
        // 1. Go to Firebase Console (console.firebase.google.com) and SELECT YOUR PROJECT.
        // 2. Click on "Project settings" (the gear icon ‚öôÔ∏è next to "Project overview").
        // 3. Scroll down to the "Your apps" section.
        // 4. Select your Web app (click the </> icon).
        // 5. COPY THE ENTIRE 'firebaseConfig' OBJECT shown there and PASTE IT BELOW, REPLACING THIS ENTIRE BLOCK.
        //    ENSURE YOU HAVE NO "YOUR_..." PLACEHOLDERS LEFT AFTER PASTING.
        // Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCu8-euGnbMCgH7N6EHco9SSe3pydNEsYM", // <--- THIS IS THE KEY FROM YOUR PROJECT
  authDomain: "my-workout-tracker-3fc32.firebaseapp.com", // <--- THIS IS THE DOMAIN FROM YOUR PROJECT
  projectId: "my-workout-tracker-3fc32", // <--- THIS IS THE PROJECT ID FROM YOUR PROJECT
  storageBucket: "my-workout-tracker-3fc32.firebasestorage.app",
  messagingSenderId: "306733497894",
  appId: "1:306733497894:web:7384aa91e5b337c9d930e7"
};

        // On GitHub Pages, 'appId' is not automatically passed from Canvas environment,
        // so we derive it from the 'projectId' in your firebaseConfig.
        const appId = firebaseConfig.projectId;

        // On GitHub Pages, there is no __initial_auth_token. Set to null to force anonymous sign-in.
        const initialAuthToken = null; // This is now unused for email/password auth
        // --- IMPORTANT: END YOUR EDITS HERE ---


        // Define the base workout data, starting from Monday for consistent weekly display
        const workoutDataStandardWeek = [
            { day: "Monday", focus: "Chest & Cardio", details: { "Warm-up": "Treadmill 5 min + arm circles", "Exercise 1": "Bench Press (3 sets x 12 reps)", "Exercise 2": "Incline Dumbbell Press (3 sets x 12 reps)", "Exercise 3": "Cable Fly / Pec Deck (3 sets x 15 reps)", "Core": "Plank (3 sets x 60s), Russian Twist (3 sets x 20 reps), Leg Raises (3 sets x 15 reps)", "Cardio": "Incline walk / cross-trainer 20 min" }},
            { day: "Tuesday", focus: "Back & Cardio", details: { "Warm-up": "Treadmill/brisk walk 5 min", "Exercise 1": "Lat Pulldown (3 sets x 12 reps)", "Exercise 2": "One-Arm Dumbbell Row (3 sets x 12 reps per arm)", "Exercise 3": "Barbell/Dumbbell Row (3 sets x 10‚Äì12 reps)", "Core": "Crunches (3 sets x 20 reps), Bicycle Kicks (3 sets x 20 reps), Side Plank (3 sets x 30s each side)", "Cardio": "Bike / elliptical / jump rope 15 min" }},
            { day: "Wednesday", focus: "Legs & Core", details: { "Warm-up": "Cycling 5 min + leg swings", "Exercise 1": "Squats (bodyweight/barbell) (3 sets x 10 reps)", "Exercise 2": "Leg Press (3 sets x 12 reps)", "Exercise 3": "Lunges (3 sets x 10 reps each leg)", "Core": "Plank (3 sets x 60s), Crunches (3 sets x 20 reps), Leg Raises (3 sets x 15 reps), Russian Twist (3 sets x 20 reps)", "Cardio": "‚Äî" }},
            { day: "Thursday", focus: "Shoulders & Arms", details: { "Warm-up": "Light cardio 5 min", "Exercise 1": "Dumbbell Shoulder Press (3 sets x 12 reps)", "Exercise 2": "Lateral Raises (3 sets x 15 reps)", "Exercise 3": "Front Raises + Shrugs (3 sets x 12‚Äì15 reps)", "Exercise 4 (Optional)": "Cable Curls / Rope Pushdowns (3 sets x 12-15 reps)", "Cardio": "Treadmill/jump rope 10‚Äì15 min" }},
            { day: "Friday", focus: "HIIT & Abs", details: { "Warm-up": "5‚Äì10 min", "HIIT Circuit": "6 moves, 3 rounds (30 sec work / 10 reps, followed by short rest). Example Moves: Burpees, Mountain Climbers, Jump Squats, High Knees, Push-ups, Plank Jacks", "Abs Finisher": "Included in HIIT (Crunches/Planks/Leg Raises as sets)", "Cardio": "Included in HIIT" }},
            { day: "Saturday", focus: "Rest Day", details: { "Activity": "Active recovery like a light walk, stretching, or complete rest." }},
            { day: "Sunday", focus: "Rest Day", details: { "Activity": "Active recovery like a light walk, stretching, or complete rest." }},
        ];

        // Calculate total days from today (July 24, 2025) until Dec 31, 2025
        const PLAN_START_DATE = new Date("2025-07-24T00:00:00"); // July 24, 2025 is a Thursday
        const PLAN_END_DATE = new Date("2025-12-31T23:59:59"); // December 31, 2025
        const TOTAL_DAYS_IN_PLAN = Math.ceil((PLAN_END_DATE - PLAN_START_DATE) / (1000 * 60 * 60 * 24)) + 1; // +1 to include the end date itself

        // Populate the full year-long plan based on the standard week cycle
        // This initial fullPlan will be overridden by Firestore data if available
        let fullPlan = []; 
        function initializeDefaultPlan() {
            fullPlan = []; // Reset to empty before re-populating
            for (let i = 0; i < TOTAL_DAYS_IN_PLAN; i++) {
                const adjustedIndex = (i + 3) % 7; 
                const dayData = workoutDataStandardWeek[adjustedIndex];
                
                fullPlan.push({
                    dayIndex: i, 
                    dayName: dayData.day,
                    focus: dayData.focus,
                    details: dayData.details,
                    completed: false
                });
            }
        }
        initializeDefaultPlan(); // Call initially to set up the default plan


        let todayActualIndex = 0; // Global variable to store today's calculated index in fullPlan

        let currentWeek = 0; 
        let progressChart;
        
        const weeklyView = document.getElementById('weekly-view');
        const weekTitle = document.getElementById('week-title');
        const prevWeekBtn = document.getElementById('prev-week');
        const nextWeekBtn = document.getElementById('next-week');
        
        const modal = document.getElementById('workout-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');

        const todayWorkoutCard = document.getElementById('today-workout-card');
        const todayTitle = document.getElementById('today-title');
        const todayDetails = document.getElementById('today-details');
        const progressChartExplanation = document.getElementById('progress-chart-explanation');
        const loadingOverlay = document.getElementById('loading-overlay');
        const authPage = document.getElementById('auth-page');
        const appContainer = document.getElementById('app');
        const userIdDisplay = document.getElementById('user-id-display'); 


        // Auth elements
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const signupButton = document.getElementById('signup-button');
        const signinButton = document.getElementById('signin-button');
        const signoutButton = document.getElementById('signout-button');
        const authErrorMessage = document.getElementById('auth-error-message');


        // Map of day names to their index in a Monday-Sunday week (Monday=0, Sunday=6)
        const dayMapStandardWeek = {
            "Monday": 0, "Tuesday": 1, "Wednesday": 2, "Thursday": 3, "Friday": 4, "Saturday": 5, "Sunday": 6
        };

        let loadingTimeout; 

        // Utility for exponential backoff retry
        async function retryOperation(operation, maxRetries = 5, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await operation();
                } catch (error) {
                    if (i === maxRetries - 1) {
                        console.error(`Failed after ${maxRetries} retries:`, error);
                        throw error;
                    }
                    await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                }
            }
        }

        async function saveProgressToFirestore() {
            if (!isAuthAndDbReady || !currentUserId) {
                console.warn("Firestore not ready or user not authenticated, skipping save.");
                return;
            }
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/workoutProgress/userProgress`);
                await retryOperation(() => setDoc(userDocRef, { planData: JSON.stringify(fullPlan) }));
            } catch (error) {
                console.error("Error saving progress to Firestore:", error);
            }
        }

        let currentFirestoreUnsubscribe = null; // Store the unsubscribe function

        async function loadProgressFromFirestore() {
            // If there's an active listener, unsubscribe first to prevent duplicates or errors
            if (currentFirestoreUnsubscribe) {
                currentFirestoreUnsubscribe();
                currentFirestoreUnsubscribe = null; // Clear the reference
            }

            if (!isAuthAndDbReady || !currentUserId) {
                console.warn("Firestore not ready or user not authenticated, skipping load.");
                loadingOverlay.classList.add('hidden'); 
                appContainer.classList.remove('hidden');
                // Ensure default plan is loaded and rendered if not authenticated
                initializeDefaultPlan(); // Reset fullPlan to default
                calculateTodayIndexAndWeek(); // Calculate today's index for current default plan
                renderWeek(currentWeek); 
                renderToday();
                return;
            }
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/workoutProgress/userProgress`);
                
                // Assign the unsubscribe function to the global variable
                currentFirestoreUnsubscribe = onSnapshot(userDocRef, (docSnap) => {
                    clearTimeout(loadingTimeout); 
                    loadingOverlay.classList.add('hidden'); 
                    appContainer.classList.remove('hidden'); 

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data && data.planData) {
                            const loadedPlan = JSON.parse(data.planData);
                            // Ensure loadedPlan structure matches fullPlan template
                            fullPlan.forEach((day, index) => {
                                if (loadedPlan[index] && loadedPlan[index].dayIndex === day.dayIndex) {
                                    day.completed = loadedPlan[index].completed;
                                }
                            });
                        }
                    } else {
                        console.log("No existing workout plan found in Firestore. Using default plan.");
                        // If no plan found, ensure fullPlan is based on default template
                        initializeDefaultPlan();
                    }
                    calculateTodayIndexAndWeek(); // Calculate today's index for current plan
                    renderWeek(currentWeek);
                    renderToday();
                }, (error) => {
                    clearTimeout(loadingTimeout); 
                    console.error("Error listening to Firestore updates:", error);
                    loadingOverlay.textContent = "Error loading plan. Please check console for details.";
                    loadingOverlay.classList.remove('hidden'); 
                    appContainer.classList.add('hidden'); 
                });

            } catch (error) {
                clearTimeout(loadingTimeout); 
                console.error("Error setting up Firestore listener:", error);
                loadingOverlay.textContent = "Error setting up Firestore. Please check console for details.";
                loadingOverlay.classList.remove('hidden'); 
                appContainer.classList.add('hidden'); 
            }
        }

        function displayAuthError(message) {
            authErrorMessage.textContent = message;
            authErrorMessage.classList.remove('hidden');
        }

        function hideAuthError() {
            authErrorMessage.classList.add('hidden');
        }

        async function handleSignUp() {
            hideAuthError();
            const email = authEmailInput.value;
            const password = authPasswordInput.value;

            // Client-side validation
            if (!email || !email.includes('@') || !email.includes('.')) {
                displayAuthError("Please enter a valid email address.");
                return;
            }
            if (!password || password.length < 6) {
                displayAuthError("Password must be at least 6 characters long.");
                return;
            }

            try {
                console.log("Attempting signup for:", email); 
                await retryOperation(() => createUserWithEmailAndPassword(auth, email, password));
                console.log("Signup successful!"); 
            } catch (error) {
                console.error("Signup error:", error); 
                displayAuthError(error.message); 
            }
        }

        async function handleSignIn() {
            hideAuthError();
            const email = authEmailInput.value;
            const password = authPasswordInput.value;

            // Client-side validation
            if (!email || !email.includes('@') || !email.includes('.')) {
                displayAuthError("Please enter a valid email address.");
                return;
            }
            if (!password || password.length < 6) {
                displayAuthError("Password must be at least 6 characters long.");
                return;
            }

            try {
                console.log("Attempting sign-in for:", email); 
                await retryOperation(() => signInWithEmailAndPassword(auth, email, password));
                console.log("Sign-in successful!"); 
            } catch (error) {
                console.error("Sign-in error:", error); 
                displayAuthError(error.message); 
            }
        }

        async function handleSignOut() {
            try {
                // Unsubscribe from Firestore listener before signing out
                if (unsubscribeFromFirestore) { // Use the correct variable name
                    unsubscribeFromFirestore();
                    unsubscribeFromFirestore = null;
                }
                await signOut(auth);
                // onAuthStateChanged will handle the UI transition
            } catch (error) {
                console.error("Error signing out:", error);
            }
        }

        async function initializeFirebaseAndAuth() {
            try {
                if (!firebaseConfig || !firebaseConfig.apiKey || 
                    firebaseConfig.apiKey === "YOUR_API_KEY" || 
                    firebaseConfig.authDomain === "YOUR_AUTH_DOMAIN" ||
                    firebaseConfig.projectId === "YOUR_PROJECT_ID") {
                    
                    clearTimeout(loadingTimeout);
                    console.error("Firebase Initialization Error: firebaseConfig is missing or contains placeholders. Please update firebaseConfig in your HTML file with actual values from Firebase Console.");
                    loadingOverlay.textContent = "Error: Firebase config invalid. See console for exact details.";
                    loadingOverlay.classList.remove('hidden'); 
                    authPage.classList.add('hidden'); 
                    appContainer.classList.add('hidden'); 
                    return; 
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                loadingTimeout = setTimeout(() => {
                    if (!auth.currentUser) { 
                        console.warn("Firebase authentication timed out. Displaying sign-in page.");
                        loadingOverlay.classList.add('hidden'); 
                        authPage.classList.remove('hidden');   
                        appContainer.classList.add('hidden');  
                    }
                }, 10000); 

                onAuthStateChanged(auth, async (user) => {
                    console.log("onAuthStateChanged fired. User:", user ? user.uid : "null"); 
                    clearTimeout(loadingTimeout); 

                    loadingOverlay.classList.add('hidden'); 
                    authPage.classList.add('hidden');       
                    appContainer.classList.add('hidden');   

                    if (user) {
                        console.log("User is logged in. Showing app."); 
                        currentUserId = user.uid;
                        const username = user.email ? user.email.split('@')[0] : 'Guest';
                        userIdDisplay.textContent = `Hello, ${username}!`; 
                        isAuthAndDbReady = true;
                        appContainer.classList.remove('hidden'); 
                        loadProgressFromFirestore(); 
                    } else {
                        console.log("User is logged out. Showing auth page."); 
                        currentUserId = null;
                        isAuthAndDbReady = false;
                        // Unsubscribe from any active listener when user logs out
                        if (unsubscribeFromFirestore) { // Use the correct variable name
                            unsubscribeFromFirestore();
                            unsubscribeFromFirestore = null;
                        }
                        initializeDefaultPlan(); // Reset fullPlan to default
                        calculateTodayIndexAndWeek(); // Re-calculate today's index for new session
                        authPage.classList.remove('hidden'); 
                        authEmailInput.value = '';
                        authPasswordInput.value = '';
                        renderWeek(currentWeek); // Re-render with default plan
                        renderToday();
                        updateProgress(); // Update progress chart for default
                    }
                });
            } catch (firebaseInitError) {
                clearTimeout(loadingTimeout); 
                console.error("Error initializing Firebase:", firebaseInitError); 
                loadingOverlay.textContent = "Init Error: Firebase not initialized. Config issue?";
                loadingOverlay.classList.remove('hidden'); 
                authPage.classList.add('hidden'); 
                appContainer.classList.add('hidden'); 
            }
        }

        // Global variable to store today's calculated index in fullPlan
        // Moved declaration here to ensure it's truly global and declared only once
        // (Previously, it might have been implicitly re-declared in some environments, causing SyntaxError)
        // let todayActualIndex = 0; // Removed duplicate declaration from here


        function calculateTodayIndexAndWeek() {
            const today = new Date();
            // Normalize today's date to midnight for accurate comparison
            today.setHours(0, 0, 0, 0);

            // Normalize PLAN_START_DATE to midnight for accurate comparison
            PLAN_START_DATE.setHours(0, 0, 0, 0);

            // Calculate the difference in days between PLAN_START_DATE and today
            const diffTime = Math.abs(today.getTime() - PLAN_START_DATE.getTime());
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            // Check if today falls within the plan's date range
            if (today >= PLAN_START_DATE && today <= PLAN_END_DATE) {
                todayActualIndex = diffDays;
            } else {
                // If today is outside the plan, set todayActualIndex to -1 or a value that indicates it's out of bounds
                todayActualIndex = -1; // Indicates "No Plan for Today"
            }

            // Calculate the current week offset based on today's position
            // Day 0 of fullPlan (Thursday) is the 3rd day of the standard week (Monday=0)
            const dayOfWeekForPlanStart = PLAN_START_DATE.getDay(); // 0=Sunday, 1=Monday... 4=Thursday
            // Adjust to our Monday-indexed week (Monday=0)
            const planStartDateDayOfWeekMonIndex = (dayOfWeekForPlanStart === 0) ? 6 : dayOfWeekForPlanStart - 1;

            // Calculate the index of the current day (today) within a Monday-Sunday week
            const todayDayOfWeekMonIndex = (today.getDay() === 0) ? 6 : today.getDay() - 1;

            // Calculate the number of days from the start of the current *calendar* week (Monday) to today
            const daysIntoCurrentCalendarWeek = todayActualIndex - todayDayOfWeekMonIndex;

            // Calculate the current week based on days from plan start, adjusted to current calendar week's Monday
            // If todayActualIndex is -1, currentWeek should likely be 0 to show the first week by default for a new session.
            if (todayActualIndex === -1) {
                 currentWeek = 0; // Default to first week if today is outside plan
            } else {
                currentWeek = Math.floor((todayActualIndex - todayDayOfWeekMonIndex) / 7);
            }
           
            // Ensure currentWeek doesn't go below 0 if somehow calculated negative (e.g. if PLAN_START_DATE is far in future)
            currentWeek = Math.max(0, currentWeek);
        }

        function renderWeek(calendarWeekOffset) {
            currentWeek = calendarWeekOffset;
            weeklyView.innerHTML = '';

            // Get the day name of the plan's original start day (Thursday for todayIndex=0)
            const currentPlanDayNameForInitialOffset = fullPlan[0].dayName; 
            // Get its index in the standard Monday-Sunday week (Thursday is index 3)
            const dayIndexInStandardWeekForPlanStart = dayMapStandardWeek[currentPlanDayNameForInitialOffset];

            // Calculate the fullPlan index of the Monday for the current displayed calendar week.
            // This needs to correctly align the fullPlan's days (starting at todayIndex=0 for Thu)
            // with the calendar week's Monday.
            // currentDisplayedCalendarWeekStartMs is the milliseconds for the Monday of the current displayed week
            const currentCalendarDate = new Date(); // Use actual current date to anchor for calculation
            currentCalendarDate.setHours(0,0,0,0);
            const currentDayOfWeek = (currentCalendarDate.getDay() === 0) ? 6 : currentCalendarDate.getDay() -1; // 0 for Mon, 6 for Sun
            
            // Calculate the start of the actual current calendar week (Monday)
            const actualCurrentCalendarMonday = new Date(currentCalendarDate);
            actualCurrentCalendarMonday.setDate(currentCalendarDate.getDate() - currentDayOfWeek);
            
            // Calculate the start of the displayed calendar week (Monday)
            const displayedCalendarMonday = new Date(actualCurrentCalendarMonday);
            displayedCalendarMonday.setDate(actualCurrentCalendarMonday.getDate() + (calendarWeekOffset * 7));

            // Now, find the index in fullPlan that corresponds to this displayedCalendarMonday
            const diffDaysFromPlanStartToDisplayedMonday = Math.floor((displayedCalendarMonday.getTime() - PLAN_START_DATE.getTime()) / (1000 * 60 * 60 * 24));
            
            const mondayOfCurrentDisplayedWeekPlanIndex = diffDaysFromPlanStartToDisplayedMonday;

            const firstDayDisplayedDate = new Date(displayedCalendarMonday);
            const lastDayDisplayedDate = new Date(displayedCalendarMonday);
            lastDayDisplayedDate.setDate(displayedCalendarMonday.getDate() + 6);

            const options = { month: 'short', day: 'numeric' };
            weekTitle.textContent = `Week ${currentWeek + 1} (${firstDayDisplayedDate.toLocaleDateString('en-US', options)} - ${lastDayDisplayedDate.toLocaleDateString('en-US', options)})`;

            const daysOfWeekLabels = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

            for (let i = 0; i < 7; i++) {
                const currentPlanIndex = mondayOfCurrentDisplayedWeekPlanIndex + i; 
                let dayDataForDisplay = fullPlan[currentPlanIndex]; 

                const card = document.createElement('div');
                // Check if this card represents today's actual date
                const cardDate = new Date(displayedCalendarMonday);
                cardDate.setDate(displayedCalendarMonday.getDate() + i);
                const isTodayCard = (cardDate.toDateString() === new Date().toDateString());


                if (!dayDataForDisplay || currentPlanIndex < 0 || currentPlanIndex >= TOTAL_DAYS_IN_PLAN) {
                    card.className = `day-card p-4 rounded-xl border-2 bg-gray-100 text-gray-400 opacity-70 pointer-events-none`;
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="day-title font-bold text-lg">${daysOfWeekLabels[i]}</p>
                                <p class="text-sm text-gray-500">No Workout</p>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" class="h-5 w-5 rounded-full text-gray-300 border-gray-300" disabled>
                            </div>
                        </div>
                        <div class="mt-4 text-center text-3xl">üò¥</div>
                    `;
                    card.dataset.dayIndex = currentPlanIndex; 
                } else {
                    card.className = `day-card p-4 rounded-xl border-2 cursor-pointer relative ${dayDataForDisplay.completed ? 'completed' : 'bg-gray-50 border-gray-200'} ${isTodayCard ? 'today-highlight' : ''}`;
                    card.dataset.dayIndex = dayDataForDisplay.dayIndex; 
                    
                    let cardContent = `
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="day-title font-bold text-lg">${daysOfWeekLabels[i]}</p>
                                <p class="text-sm text-gray-500">${dayDataForDisplay.focus}</p>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" class="h-5 w-5 rounded-full text-green-500 border-gray-300 focus:ring-green-500" ${dayDataForDisplay.completed ? 'checked' : ''} data-day-index="${dayDataForDisplay.dayIndex}">
                            </div>
                        </div>
                    `;
                    
                    if (dayDataForDisplay.focus === 'Rest Day') {
                        cardContent += `<div class="mt-4 text-center text-3xl">üßò</div>`;
                    } else {
                        cardContent += `<div class="mt-4 text-center text-3xl">üí™</div>`;
                    }
                    card.innerHTML = cardContent;
                }
                weeklyView.appendChild(card);
            }

            const earliestMondayInPlan = new Date(PLAN_START_DATE);
            earliestMondayInPlan.setDate(PLAN_START_DATE.getDate() - dayMapStandardWeek[PLAN_START_DATE.toLocaleString('default', { weekday: 'long' })]);

            const latestSundayInPlan = new Date(PLAN_END_DATE);
            latestSundayInPlan.setDate(PLAN_END_DATE.getDate() + (6 - dayMapStandardWeek[PLAN_END_DATE.toLocaleString('default', { weekday: 'long' })]));
            
            prevWeekBtn.disabled = displayedCalendarMonday <= earliestMondayInPlan;
            nextWeekBtn.disabled = displayedCalendarMonday >= latestSundayInPlan;

            updateProgress();
        }
        
        function openModal(dayIndex) {
            const day = fullPlan[dayIndex];
            if (!day || dayIndex < 0 || dayIndex >= TOTAL_DAYS_IN_PLAN) return; 

            modalTitle.textContent = `${day.dayName}: ${day.focus}`;
            modalBody.innerHTML = '';
            
            for (const [key, value] of Object.entries(day.details)) {
                const detailEl = document.createElement('div');
                detailEl.innerHTML = `<p><strong class="font-semibold text-gray-800">${key}:</strong> ${value}</p>`;
                modalBody.appendChild(detailEl);
            }
            
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.remove('scale-95');
        }

        function closeModal() {
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.add('scale-95');
        }

        function updateProgress() {
            const currentPlanDayName = fullPlan[todayActualIndex]?.dayName; // Use todayActualIndex
            const dayIndexInStandardWeek = currentPlanDayName ? dayMapStandardWeek[currentPlanDayName] : 0; // Default to 0 if today is out of plan
            
            // Calculate the Monday of the current *displayed* calendar week
            const currentCalendarDateForProgress = new Date();
            currentCalendarDateForProgress.setHours(0,0,0,0);
            const currentDayOfWeekForProgress = (currentCalendarDateForProgress.getDay() === 0) ? 6 : currentCalendarDateForProgress.getDay() - 1;
            const actualCurrentCalendarMonday = new Date(currentCalendarDateForProgress);
            actualCurrentCalendarMonday.setDate(currentCalendarDateForProgress.getDate() - currentDayOfWeekForProgress);

            const displayedCalendarMonday = new Date(actualCurrentCalendarMonday);
            displayedCalendarMonday.setDate(actualCurrentCalendarMonday.getDate() + (currentWeek * 7)); // currentWeek is the offset from actual current week

            const month = displayedCalendarMonday.getMonth();
            const year = displayedCalendarMonday.getFullYear();

            let completedThisMonth = 0;
            let totalDaysInMonthInPlan = 0;

            fullPlan.forEach(day => {
                const actualDate = new Date(PLAN_START_DATE);
                actualDate.setDate(PLAN_START_DATE.getDate() + day.dayIndex);

                if (actualDate.getMonth() === month && actualDate.getFullYear() === year) {
                    totalDaysInMonthInPlan++;
                    if (day.completed) {
                        completedThisMonth++;
                    }
                }
            });

            const remainingThisMonth = totalDaysInMonthInPlan - completedThisMonth;
            const monthName = displayedCalendarMonday.toLocaleString('default', { month: 'long' });

            if (progressChart) {
                progressChart.data.datasets[0].data = [completedThisMonth, remainingThisMonth];
                progressChart.data.labels = [`Completed in ${monthName}`, `Remaining in ${monthName}`];
                progressChart.update();
            }

            progressChartExplanation.textContent = `This chart shows your progress for ${monthName}.`;
        }


        function renderToday() {
            const todayData = fullPlan[todayActualIndex]; // Use the calculated todayActualIndex
            if (todayActualIndex !== -1 && todayData) { // Check if today is within the plan
                todayTitle.textContent = `${todayData.dayName}: ${todayData.focus}`;
                todayDetails.innerHTML = '';
                for (const [key, value] of Object.entries(todayData.details)) {
                    const p = document.createElement('p');
                    p.innerHTML = `<strong class="font-semibold text-gray-800">${key}:</strong> ${value}</p>`;
                    todayDetails.appendChild(p);
                }
            } else {
                todayTitle.textContent = `No Plan for Today`;
                todayDetails.innerHTML = `<p>It looks like today is outside your defined workout plan (or the plan has ended).</p>`;
            }
        }

        function createChart() {
            const ctx = document.getElementById('progressChart').getContext('2d');
            progressChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'Remaining'],
                    datasets: [{
                        data: [0, TOTAL_DAYS_IN_PLAN],
                        backgroundColor: ['#22C55E', '#E5E7EB'],
                        borderColor: ['#FDFBF8'],
                        borderWidth: 4,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true
                        }
                    }
                }
            });
        }

        prevWeekBtn.addEventListener('click', () => renderWeek(currentWeek - 1));
        nextWeekBtn.addEventListener('click', () => renderWeek(currentWeek + 1));
        
        weeklyView.addEventListener('click', async (e) => {
            const card = e.target.closest('.day-card');
            if (!card) return;

            const dayIndex = parseInt(card.dataset.dayIndex);

            if (card.classList.contains('pointer-events-none')) {
                return;
            }

            if (e.target.type === 'checkbox') {
                fullPlan[dayIndex].completed = e.target.checked;
                card.classList.toggle('completed', e.target.checked);
                await saveProgressToFirestore(); // Save to Firestore
                updateProgress();
            } else {
                openModal(dayIndex);
            }
        });

        closeModalBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });

        signupButton.addEventListener('click', handleSignUp);
        signinButton.addEventListener('click', handleSignIn);
        signoutButton.addEventListener('click', handleSignOut);


        document.addEventListener('DOMContentLoaded', () => {
            createChart();
            calculateTodayIndexAndWeek(); // Calculate today's index and initial week
            initializeFirebaseAndAuth();
        });

    </script>
</body>
</html>
